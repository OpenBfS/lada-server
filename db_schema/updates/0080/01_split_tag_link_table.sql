-- Splits up the tag link table into two seperate tables:
-- tag_link_sample and tag_link_measm

set search_path to lada;

CREATE TABLE tag_link_measm
(
    id serial PRIMARY KEY,
    measm_id integer NOT NULL REFERENCES measm ON DELETE CASCADE,
    tag_id integer NOT NULL REFERENCES master.tag ON DELETE CASCADE,
    date timestamp without time zone
        NOT NULL DEFAULT (now() AT TIME ZONE ''utc''),
    CHECK(measm_id IS NOT NULL),
    UNIQUE (measm_id, tag_id)
);
CREATE TABLE tag_link_sample
(
    id serial PRIMARY KEY,
    sample_id integer NOT NULL REFERENCES sample ON DELETE CASCADE,
    tag_id integer NOT NULL REFERENCES master.tag ON DELETE CASCADE,
    date timestamp without time zone
        NOT NULL DEFAULT (now() AT TIME ZONE ''utc''),
    CHECK(sample_id IS NOT NULL),
    UNIQUE (sample_id, tag_id)
);

GRANT SELECT, INSERT, UPDATE, DELETE, REFERENCES
    ON tag_link_measm TO lada;
GRANT SELECT, INSERT, UPDATE, DELETE, REFERENCES
    ON tag_link_sample TO lada;
GRANT USAGE, SELECT ON SEQUENCE tag_link_measm_id_seq TO lada;
GRANT USAGE, SELECT ON SEQUENCE tag_link_sample_id_seq TO lada;

-- Migrate entries into new tables
INSERT INTO tag_link_measm
    (
        tag_id,
        measm_id,
        date
    )
    SELECT
        tl.tag_id,
        tl.measm_id,
        tl.date
    FROM
        tag_link tl
    WHERE
        tl.measm_id IS NOT NULL;

INSERT INTO tag_link_sample
    (
        tag_id,
        sample_id,
        date
    )
    SELECT
        tl.tag_id,
        tl.sample_id,
        tl.date
    FROM
        tag_link tl
    WHERE
        tl.sample_id IS NOT NULL;

-- Update german view
CREATE OR REPLACE VIEW land.tagzuordnung AS
SELECT
    id,
    sample_id AS probe_id,
    tag_id,
    date AS datum,
    NULL AS messung_id
FROM lada.tag_link_sample
UNION ALL
SELECT
    id,
    NULL AS probe_id,
    tag_id,
    date AS datum,
    measm_id AS messung_id
FROM lada.tag_link_measm;

-- Update queries
UPDATE master.base_query
    SET sql = 'SELECT sample.id AS probeId, sample.main_sample_id AS hpNr, regulation.name AS dBasis, meas_facil.network_id AS netzId, CASE WHEN sample.meas_facil_id = sample.appr_lab_id THEN sample.meas_facil_id ELSE sample.meas_facil_id || ''-'' || sample.appr_lab_id END AS mstLaborId, sample.env_medium_id AS umwId, sample_meth.ext_id AS pArt, sample.sched_start_date AS sollBegin, sample.sched_end_date AS sollEnd, sample.sample_start_date AS peBegin, sample.sample_end_date AS peEnd, site.ext_id AS ortId, site.admin_unit_id AS eGemId, admin_unit.name AS eGem, sample.ext_id AS externeProbeId, sample.mpg_id AS mprId, mpg_categ.ext_id AS mplCode, mpg_categ.name AS mpl, env_medium.name AS umw, network.name AS netzbetreiber, CASE WHEN sample.meas_facil_id = sample.appr_lab_id THEN meas_facil.name ELSE meas_facil.name || ''-'' || labormessstelle.name END AS mstLabor, nucl_facil_gr.ext_id AS anlage, nucl_facil_gr.name AS anlagebeschr, rei_ag_gr.name AS reiproggrp, rei_ag_gr.descr AS reiproggrpbeschr, sample.is_test, opr_mode.name AS messRegime, site.short_text AS ortKurztext, site.long_text AS ortLangtext, sample.env_descrip_display AS deskriptoren, sample.env_descrip_name AS medium, sampler.descr AS prnBezeichnung, sampler.ext_id AS prnId, sampler.short_text AS prnKurzBezeichnung, geolocat.add_site_text AS ortszusatztext, geolocat.poi_id AS ozId, poi.name AS oz, admin_unit.rural_dist_id AS eKreisId, admin_unit.state_id AS eBlId, state.ctry AS eStaat, array_to_string(tags.tags, '','', '''') AS tags, sample.mid_coll_pd AS mitteSammelzeitraum, staat_uo.ctry AS uStaat, ort_uo.ext_id AS uOrtId, sample.orig_date AS uZeit, ortszuordnung_uo.poi_id AS uOzId, ortszusatz_uo.name AS uOz, pkommentar.pkommentar AS pKommentar, PUBLIC.ST_ASGEOJSON(site.geom) AS entnahmeGeom FROM lada.sample LEFT JOIN ( SELECT sample.id, array_agg(tag.name) AS tags FROM lada.sample JOIN lada.tag_link_sample ON sample.id = tag_link_sample.sample_id JOIN master.tag ON tag_link_sample.tag_id = tag.id GROUP BY sample.id) tags ON sample.id = tags.id LEFT JOIN master.meas_facil ON (sample.meas_facil_id = meas_facil.id) LEFT JOIN master.meas_facil AS labormessstelle ON (sample.appr_lab_id = labormessstelle.id) LEFT JOIN master.regulation ON (sample.regulation_id = regulation.id) LEFT JOIN master.sample_meth ON (sample.sample_meth_id = sample_meth.id) LEFT JOIN lada.geolocat ON (sample.id = geolocat.sample_id AND geolocat.type_regulation IN (''E'', ''R'')) LEFT JOIN master.site ON (geolocat.site_id = site.id) LEFT JOIN master.admin_unit ON (site.admin_unit_id = admin_unit.id) LEFT JOIN master.poi ON (geolocat.poi_id = poi.id) LEFT JOIN master.state ON (site.state_id = state.id) LEFT JOIN lada.geolocat AS ortszuordnung_uo ON (sample.id = ortszuordnung_uo.sample_id AND ortszuordnung_uo.type_regulation IN (''U'', ''R'')) LEFT JOIN master.site AS ort_uo ON (ortszuordnung_uo.site_id = ort_uo.id) LEFT JOIN master.state AS staat_uo ON (ort_uo.state_id = staat_uo.id) LEFT JOIN master.poi AS ortszusatz_uo ON (ortszuordnung_uo.poi_id = ortszusatz_uo.id) LEFT JOIN master.mpg_categ ON (sample.mpg_categ_id = mpg_categ.id) LEFT JOIN master.env_medium ON (sample.env_medium_id = env_medium.id) LEFT JOIN master.network ON (meas_facil.network_id = network.id) LEFT JOIN master.nucl_facil_gr ON (sample.nucl_facil_gr_id = nucl_facil_gr.id) LEFT JOIN master.rei_ag_gr ON (sample.rei_ag_gr_id = rei_ag_gr.id) LEFT JOIN master.opr_mode ON (sample.opr_mode_id = opr_mode.id) LEFT JOIN master.sampler ON (sample.sampler_id = sampler.id)  LEFT JOIN ( SELECT sample.id, string_agg(comm_sample.text,'' # '') AS pkommentar FROM lada.sample LEFT JOIN lada.comm_sample ON sample.id = comm_sample.sample_id GROUP BY sample.id)  pkommentar ON sample.id = pkommentar.id'
    WHERE id = 1;
UPDATE master.base_query
    SET sql = 'SELECT measm.id, sample.id AS probeId, sample.main_sample_id AS hpNr, measm.min_sample_id AS npNr, status_prot.date AS statusD, regulation.name AS dBasis, meas_facil.network_id AS netzId, CASE WHEN sample.meas_facil_id = sample.appr_lab_id THEN sample.meas_facil_id ELSE sample.meas_facil_id || ''-'' || sample.appr_lab_id END AS mstLaborId, sample.env_medium_id AS umwId, sample_meth.ext_id AS pArt, sample.sample_start_date AS peBegin, sample.sample_end_date AS peEnd, site.admin_unit_id AS eGemId, admin_unit.name AS eGem, CASE WHEN h3.less_than_lod = ''<'' THEN h3.less_than_lod || translate(to_char(h3.detect_lim, ''0.99eeee''),''.'','','') ELSE translate(to_char(h3.meas_val, ''0.99eeee''),''.'','','') END AS h3, CASE WHEN k40.less_than_lod = ''<'' THEN k40.less_than_lod || translate(to_char(k40.detect_lim, ''0.99eeee''),''.'','','') ELSE translate(to_char(k40.meas_val, ''0.99eeee''),''.'','','') END AS k40, CASE WHEN co60.less_than_lod = ''<'' THEN co60.less_than_lod || translate(to_char(co60.detect_lim, ''0.99eeee''),''.'','','') ELSE translate(to_char(co60.meas_val, ''0.99eeee''),''.'','','') END AS co60, CASE WHEN sr89.less_than_lod = ''<'' THEN sr89.less_than_lod || translate(to_char(sr89.detect_lim, ''0.99eeee''),''.'','','') ELSE translate(to_char(sr89.meas_val, ''0.99eeee''),''.'','','') END AS sr89, CASE WHEN sr90.less_than_lod = ''<'' THEN sr90.less_than_lod || translate(to_char(sr90.detect_lim, ''0.99eeee''),''.'','','') ELSE translate(to_char(sr90.meas_val, ''0.99eeee''),''.'','','') END AS sr90, CASE WHEN ru103.less_than_lod = ''<'' THEN ru103.less_than_lod || translate(to_char(ru103.detect_lim, ''0.99eeee''),''.'','','') ELSE translate(to_char(ru103.meas_val, ''0.99eeee''),''.'','','') END AS ru103, CASE WHEN i131.less_than_lod = ''<'' THEN i131.less_than_lod || translate(to_char(i131.detect_lim, ''0.99eeee''),''.'','','') ELSE translate(to_char(i131.meas_val, ''0.99eeee''),''.'','','') END AS i131, CASE WHEN cs134.less_than_lod = ''<'' THEN cs134.less_than_lod || translate(to_char(cs134.detect_lim, ''0.99eeee''),''.'','','') ELSE translate(to_char(cs134.meas_val, ''0.99eeee''),''.'','','') END AS cs134, CASE WHEN cs137.less_than_lod = ''<'' THEN cs137.less_than_lod || translate(to_char(cs137.detect_lim, ''0.99eeee''),''.'','','') ELSE translate(to_char(cs137.meas_val, ''0.99eeee''),''.'','','') END AS cs137, CASE WHEN ce144.less_than_lod = ''<'' THEN ce144.less_than_lod || translate(to_char(ce144.detect_lim, ''0.99eeee''),''.'','','') ELSE translate(to_char(ce144.meas_val, ''0.99eeee''),''.'','','') END AS ce144, CASE WHEN u234.less_than_lod = ''<'' THEN u234.less_than_lod || translate(to_char(u234.detect_lim, ''0.99eeee''),''.'','','') ELSE translate(to_char(u234.meas_val, ''0.99eeee''),''.'','','') END AS u234, CASE WHEN u235.less_than_lod = ''<'' THEN u235.less_than_lod || translate(to_char(u235.detect_lim, ''0.99eeee''),''.'','','') ELSE translate(to_char(u235.meas_val, ''0.99eeee''),''.'','','') END AS u235, CASE WHEN u238.less_than_lod = ''<'' THEN u238.less_than_lod || translate(to_char(u238.detect_lim, ''0.99eeee''),''.'','','') ELSE translate(to_char(u238.meas_val, ''0.99eeee''),''.'','','') END AS u238, CASE WHEN pu238.less_than_lod = ''<'' THEN pu238.less_than_lod || translate(to_char(pu238.detect_lim, ''0.99eeee''),''.'','','') ELSE translate(to_char(pu238.meas_val, ''0.99eeee''),''.'','','') END AS pu238, CASE WHEN pu239.less_than_lod = ''<'' THEN pu239.less_than_lod || translate(to_char(pu239.detect_lim, ''0.99eeee''),''.'','','') ELSE translate(to_char(pu239.meas_val, ''0.99eeee''),''.'','','') END AS pu239, CASE WHEN pu23940.less_than_lod = ''<'' THEN pu23940.less_than_lod || translate(to_char(pu23940.detect_lim, ''0.99eeee''),''.'','','') ELSE translate(to_char(pu23940.meas_val, ''0.99eeee''),''.'','','') END AS pu23940, CASE WHEN te132.less_than_lod = ''<'' THEN te132.less_than_lod || translate(to_char(te132.detect_lim, ''0.99eeee''),''.'','','') ELSE translate(to_char(te132.meas_val, ''0.99eeee''),''.'','','') END AS te132, CASE WHEN pb212.less_than_lod = ''<'' THEN pb212.less_than_lod || translate(to_char(pb212.detect_lim, ''0.99eeee''),''.'','','') ELSE translate(to_char(pb212.meas_val, ''0.99eeee''),''.'','','') END AS pb212, CASE WHEN pb214.less_than_lod = ''<'' THEN pb214.less_than_lod || translate(to_char(pb214.detect_lim, ''0.99eeee''),''.'','','') ELSE translate(to_char(pb214.meas_val, ''0.99eeee''),''.'','','') END AS pb214, CASE WHEN bi212.less_than_lod = ''<'' THEN bi212.less_than_lod || translate(to_char(bi212.detect_lim, ''0.99eeee''),''.'','','') ELSE translate(to_char(bi212.meas_val, ''0.99eeee''),''.'','','') END AS bi212, CASE WHEN bi214.less_than_lod = ''<'' THEN bi214.less_than_lod || translate(to_char(bi214.detect_lim, ''0.99eeee''),''.'','','') ELSE translate(to_char(bi214.meas_val, ''0.99eeee''),''.'','','') END AS bi214, measm.mmt_id AS mmtId, sample.ext_id AS externeProbeId, measm.ext_id AS externeMessungsId, status_mp.id AS statusK, env_medium.name AS umw, network.name AS netzbetreiber, PUBLIC.ST_ASGEOJSON(site.geom) AS entnahmeGeom, nucl_facil_gr.ext_id AS anlage, nucl_facil_gr.name AS anlagebeschr, rei_ag_gr.name AS reiproggrp, rei_ag_gr.descr AS reiproggrpbeschr, sample.mpg_id AS mprId, mpg_categ.ext_id AS mplCode, mpg_categ.name AS mpl, sample.is_test, opr_mode.name AS messRegime, CASE WHEN sample.meas_facil_id = sample.appr_lab_id THEN meas_facil.name ELSE meas_facil.name || ''-'' || labormessstelle.name END AS mstLabor, measm.is_scheduled AS geplant, sample.sched_start_date AS sollBegin, sample.sched_end_date AS sollEnd, site.ext_id AS ortId, site.short_text AS ortKurztext, site.long_text AS ortLangtext, sampler.descr AS prnBezeichnung, sampler.ext_id AS prnId, sampler.short_text AS prnKurzBezeichnung, mmt.name AS mmt, measm.measm_start_date AS messbeginn, measm.meas_pd AS messdauer, sample.env_descrip_display AS deskriptoren, sample.env_descrip_name AS medium, geolocat.poi_id AS ozId, poi.name AS oz, admin_unit.rural_dist_id AS eKreisId, admin_unit.state_id AS eBlId, state.ctry AS eStaat, measm.is_completed AS fertig, (query_measm_view.measm_id IS NOT NULL) AS hatRueckfrage, staat_uo.ctry AS uStaat, ort_uo.ext_id AS uOrtId, sample.orig_date AS uZeit, array_to_string(tags.tags, '','', '''') AS tags, ortszuordnung_uo.poi_id AS uOzId, ortszusatz_uo.name AS uOz, status_prot.text AS statusKommentar FROM lada.sample LEFT JOIN master.meas_facil ON (sample.meas_facil_id = meas_facil.id) LEFT JOIN master.meas_facil AS labormessstelle ON (sample.appr_lab_id = labormessstelle.id) INNER JOIN lada.measm ON sample.id = measm.sample_id INNER JOIN lada.status_prot ON measm.status = status_prot.id LEFT JOIN master.status_mp ON status_prot.status_mp_id = status_mp.id LEFT JOIN master.status_val ON status_val.id = status_mp.status_val_id LEFT JOIN master.status_lev ON status_lev.id = status_mp.status_lev_id LEFT JOIN lada.query_measm_view ON query_measm_view.measm_id = measm.id LEFT JOIN master.regulation ON (sample.regulation_id = regulation.id) LEFT JOIN master.sample_meth ON (sample.sample_meth_id = sample_meth.id) LEFT JOIN lada.geolocat ON (sample.id = geolocat.sample_id AND geolocat.type_regulation IN (''E'', ''R'')) LEFT JOIN master.site ON (geolocat.site_id = site.id) LEFT JOIN master.admin_unit ON (site.admin_unit_id = admin_unit.id) LEFT JOIN master.poi ON (geolocat.poi_id = poi.id) LEFT JOIN master.state ON (site.state_id = state.id) LEFT JOIN lada.geolocat AS ortszuordnung_uo ON (sample.id = ortszuordnung_uo.sample_id AND ortszuordnung_uo.type_regulation IN (''U'', ''R'')) LEFT JOIN master.site AS ort_uo ON (ortszuordnung_uo.site_id = ort_uo.id)  LEFT JOIN master.state AS staat_uo ON (ort_uo.state_id = staat_uo.id)  LEFT JOIN master.poi AS ortszusatz_uo ON (ortszuordnung_uo.poi_id = ortszusatz_uo.id) LEFT JOIN master.env_medium ON (sample.env_medium_id = env_medium.id) LEFT JOIN master.network ON (meas_facil.network_id = network.id) LEFT JOIN master.nucl_facil_gr ON (sample.nucl_facil_gr_id = nucl_facil_gr.id) LEFT JOIN master.rei_ag_gr ON (sample.rei_ag_gr_id = rei_ag_gr.id) LEFT JOIN master.mpg_categ ON (sample.mpg_categ_id = mpg_categ.id) LEFT JOIN master.opr_mode ON (sample.opr_mode_id = opr_mode.id) LEFT JOIN public.lada_meas_val h3 ON (h3.measm_id = measm.id AND h3.measd_id = 1) LEFT JOIN public.lada_meas_val k40 ON (k40.measm_id = measm.id AND k40.measd_id = 28) LEFT JOIN public.lada_meas_val co60 ON (co60.measm_id = measm.id AND co60.measd_id = 68) LEFT JOIN public.lada_meas_val sr89 ON (sr89.measm_id = measm.id AND sr89.measd_id = 164) LEFT JOIN public.lada_meas_val sr90 ON (sr90.measm_id = measm.id AND sr90.measd_id = 165) LEFT JOIN public.lada_meas_val ru103 ON (ru103.measm_id = measm.id AND ru103.measd_id = 220) LEFT JOIN public.lada_meas_val i131 ON (i131.measm_id = measm.id AND i131.measd_id = 340) LEFT JOIN public.lada_meas_val cs134 ON (cs134.measm_id = measm.id AND cs134.measd_id = 369) LEFT JOIN public.lada_meas_val cs137 ON (cs137.measm_id = measm.id AND cs137.measd_id = 373) LEFT JOIN public.lada_meas_val ce144 ON (ce144.measm_id = measm.id AND ce144.measd_id = 404) LEFT JOIN public.lada_meas_val u234 ON (u234.measm_id = measm.id AND u234.measd_id = 746) LEFT JOIN public.lada_meas_val u235 ON (u235.measm_id = measm.id AND u235.measd_id = 747) LEFT JOIN public.lada_meas_val u238 ON (u238.measm_id = measm.id AND u238.measd_id = 750) LEFT JOIN public.lada_meas_val pu238 ON (pu238.measm_id = measm.id AND pu238.measd_id = 768) LEFT JOIN public.lada_meas_val pu239 ON (pu239.measm_id = measm.id AND pu239.measd_id = 769) LEFT JOIN public.lada_meas_val pu23940 ON (pu23940.measm_id = measm.id AND pu23940.measd_id = 850) LEFT JOIN public.lada_meas_val te132 ON (te132.measm_id = measm.id AND te132.measd_id = 325) LEFT JOIN public.lada_meas_val pb212 ON (pb212.measm_id = measm.id AND pb212.measd_id = 672) LEFT JOIN public.lada_meas_val pb214 ON (pb214.measm_id = measm.id AND pb214.measd_id = 673) LEFT JOIN public.lada_meas_val bi212 ON (bi212.measm_id = measm.id AND bi212.measd_id = 684) LEFT JOIN public.lada_meas_val bi214 ON (bi214.measm_id = measm.id AND bi214.measd_id = 686) LEFT JOIN master.sampler ON (sample.sampler_id = sampler.id) LEFT JOIN master.mmt ON (measm.mmt_id = mmt.id) LEFT JOIN  (   SELECT sample.id AS pid, measm.id AS mid, array_agg(tag.name) AS tags FROM lada.sample INNER JOIN lada.measm ON sample.id = measm.sample_id JOIN lada.tag_link_sample ON (sample.id = tag_link_sample.sample_id) JOIN lada.tag_link_measm ON (measm.id = tag_link_measm.measm_id) JOIN master.tag ON (tag_link_sample.tag_id = tag.id OR tag_link_measm.tag_id = tag.id)  GROUP BY sample.id, measm.id ) tags ON (sample.id = tags.pid AND measm.id = tags.mid)'
    WHERE id = 11;
UPDATE master.base_query
    SET sql = 'SELECT sample.id AS probeId,   sample.main_sample_id AS hpNr,   regulation.name AS dBasis,   meas_facil.network_id AS netzId,   CASE      WHEN sample.meas_facil_id = sample.appr_lab_id       THEN sample.meas_facil_id     ELSE sample.meas_facil_id || ''-'' || sample.appr_lab_id     END AS mstLaborId,   sample.env_medium_id AS umwId,   sample_meth.ext_id AS pArt,   sample.sched_start_date AS sollBegin,   sample.sched_end_date AS sollEnd,   sample.sample_start_date AS peBegin,   sample.sample_end_date AS peEnd,   site.ext_id AS ortId,   site.admin_unit_id AS eGemId,   admin_unit.name AS eGem,   sample.ext_id AS externeProbeId,   sample.mpg_id AS mprId,   mpg_categ.ext_id AS mplCode,   mpg_categ.name AS mpl,   env_medium.name AS umw,   network.name AS netzbetreiber,   CASE      WHEN sample.meas_facil_id = sample.appr_lab_id       THEN meas_facil.name     ELSE meas_facil.name || ''-'' || labormessstelle.name     END AS mstLabor,   nucl_facil_gr.ext_id AS anlage,   nucl_facil_gr.name AS anlagebeschr,   rei_ag_gr.name AS reiproggrp,   rei_ag_gr.descr AS reiproggrpbeschr,   sample.is_test,   opr_mode.name AS messRegime,   measm.is_scheduled AS geplant, measm.measm_start_date AS messbeginn, measm.mmt_id AS mmtId, mmt.name AS mmt, sampler.descr AS prnBezeichnung, sample.env_descrip_display AS deskriptoren,   sample.env_descrip_name AS medium,  pkommentar.pkommentar AS pKommentar, pzs.pzs, geolocat.poi_id AS ozId,   staat_uo.ctry AS uStaat, status_mp.id AS statusK, sampler.ext_id AS prnId,   sampler.short_text AS prnKurzBezeichnung,  measm.id, mpg.sample_quant AS probemenge, measm.meas_pd AS messdauer, admin_unit.rural_dist_id AS eKreisId,   admin_unit.state_id AS eBlId,   state.ctry AS eStaat,   admin_unit.gov_dist_id AS eRbezId, measm.ext_id AS externeMessungsId, sampler.inst AS prnBetrieb, sampler.zip AS prnPlz, sampler.city AS prnOrt, sampler.street AS prnStrasse, sampler.phone AS prnTelefon, sampler.comm AS prnBemerkung, mpg.comm_mpg AS mprKommentar, site.short_text AS ortKurztext,   site.long_text AS ortLangtext,   verwaltungseinheit_kreis.name AS eKreis, verwaltungseinheit_rbez.name AS eRbez, meas_facil.address AS mstBeschr, master.get_desk_description(sample.env_descrip_display, 2) AS desk2Beschr, array_to_string(tags.tags, '','', '''') AS tags FROM lada.sample LEFT JOIN master.meas_facil ON (sample.meas_facil_id = meas_facil.id) LEFT JOIN master.meas_facil AS labormessstelle ON (sample.appr_lab_id = labormessstelle.id) LEFT JOIN master.regulation ON (sample.regulation_id = regulation.id) LEFT JOIN master.sample_meth ON (sample.sample_meth_id = sample_meth.id) LEFT JOIN lada.geolocat ON (sample.id = geolocat.sample_id AND geolocat.type_regulation IN (''E'', ''R'')) LEFT JOIN master.site ON (geolocat.site_id = site.id) LEFT JOIN master.admin_unit ON (site.admin_unit_id = admin_unit.id) LEFT JOIN master.admin_unit AS verwaltungseinheit_kreis ON (admin_unit.rural_dist_id = verwaltungseinheit_kreis.id) LEFT JOIN master.admin_unit AS verwaltungseinheit_rbez ON (admin_unit.gov_dist_id = verwaltungseinheit_rbez.id) LEFT JOIN master.state ON (site.state_id = state.id) LEFT JOIN master.mpg_categ ON (sample.mpg_categ_id = mpg_categ.id) LEFT JOIN master.env_medium ON (sample.env_medium_id = env_medium.id) LEFT JOIN master.network ON (meas_facil.network_id = network.id) LEFT JOIN master.nucl_facil_gr ON (sample.nucl_facil_gr_id = nucl_facil_gr.id) LEFT JOIN master.rei_ag_gr ON (sample.rei_ag_gr_id = rei_ag_gr.id) LEFT JOIN master.opr_mode ON (sample.opr_mode_id = opr_mode.id) INNER JOIN lada.measm ON sample.id = measm.sample_id LEFT JOIN master.mmt ON (measm.mmt_id = mmt.id) LEFT JOIN master.sampler ON (sample.sampler_id = sampler.id) LEFT JOIN lada.geolocat AS ortszuordnung_uo ON (sample.id = ortszuordnung_uo.sample_id AND ortszuordnung_uo.type_regulation IN (''U'', ''R'')) LEFT JOIN master.site AS ort_uo ON (ortszuordnung_uo.site_id = ort_uo.id)  LEFT JOIN master.state AS staat_uo ON (ort_uo.state_id = staat_uo.id)  INNER JOIN lada.status_prot ON measm.status = status_prot.id LEFT JOIN master.status_mp ON status_prot.status_mp_id = status_mp.id LEFT JOIN lada.mpg ON (sample.mpg_id = mpg.id) LEFT JOIN ( SELECT sample.id, array_to_string(array_agg(sample_specif_meas_val.sample_specif_id || '' '' || sample_specif.name || '': '' ||  coalesce(sample_specif_meas_val.smaller_than,'''') || '' '' || coalesce(translate(to_char(sample_specif_meas_val.meas_val,''9.99EEEE''),''.'','',''),'''') || '' '' || coalesce(pzsmeh.unit_symbol,'''') || CASE WHEN sample_specif_meas_val.error IS NOT NULL THEN '' +/-'' ELSE '''' END || coalesce(translate(to_char(sample_specif_meas_val.error,''99.9''),''.'','',''),'''') || CASE WHEN sample_specif_meas_val.error IS NOT NULL THEN '' %'' ELSE '''' END), '' # '', '''') AS pzs FROM lada.sample LEFT JOIN lada.sample_specif_meas_val ON (sample.id =  sample_specif_meas_val.sample_id) LEFT JOIN master.sample_specif ON (sample_specif_meas_val.sample_specif_id = sample_specif.id) LEFT JOIN master.meas_unit AS pzsmeh ON (sample_specif.meas_unit_id = pzsmeh.id) GROUP BY sample.id) pzs ON sample.id = pzs.id LEFT JOIN ( SELECT sample.id, string_agg(comm_sample.text,'' # '') AS pkommentar FROM lada.sample LEFT JOIN lada.comm_sample ON sample.id = comm_sample.sample_id GROUP BY sample.id)  pkommentar ON sample.id = pkommentar.id LEFT JOIN  (   SELECT sample.id AS pid, measm.id AS mid, array_agg(tag.name) AS tags   FROM lada.sample   INNER JOIN lada.measm ON sample.id = measm.sample_id JOIN lada.tag_link_sample ON (sample.id = tag_link_sample.sample_id) JOIN lada.tag_link_measm ON (measm.id = tag_link_measm.measm_id) JOIN master.tag ON (tag_link_sample.tag_id = tag.id OR tag_link_measm.tag_id = tag.id)   GROUP BY sample.id, measm.id ) tags ON (sample.id = tags.pid AND measm.id = tags.mid)'
    WHERE id = 12;
UPDATE master.base_query
    SET sql = 'SELECT sample.id AS id, sample.ext_id AS externeProbeId,   meas_facil.network_id AS netzId, network.name AS netzbetreiber,   sample.meas_facil_id AS mstId, sample.regulation_id AS datenbasisId, sample.is_test, sample.opr_mode_id AS baId, sample_meth.ext_id AS probenartId, sample.sched_start_date AS solldatumBeginn, sample.sched_end_date AS solldatumEnde, sample.mpg_id AS mprId,   sample.env_descrip_display AS mediaDesk, sample.env_medium_id AS umwId,   array_to_string(mmtid.mmt, '', '', '''') AS mmt, site.admin_unit_id AS eGemId, sampler.id AS probeNehmerId,  array_to_string(tags.tags, '','', '''') AS tags FROM lada.sample LEFT JOIN  (   SELECT sample.id,     array_agg(tag.name) AS tags   FROM lada.sample   JOIN lada.tag_link_sample ON sample.id = tag_link_sample.sample_id   JOIN master.tag ON tag_link_sample.tag_id = tag.id   GROUP BY sample.id  ) tags ON sample.id = tags.id LEFT JOIN master.meas_facil ON (sample.meas_facil_id = meas_facil.id) LEFT JOIN master.sample_meth ON (sample.sample_meth_id = sample_meth.id) LEFT JOIN lada.geolocat ON (sample.id = geolocat.sample_id AND geolocat.type_regulation IN (''E'', ''R'')) LEFT JOIN master.site ON (geolocat.site_id = site.id) LEFT JOIN master.network ON (meas_facil.network_id = network.id) LEFT JOIN master.sampler ON (sample.sampler_id = sampler.id) LEFT JOIN ( SELECT sample.id as pid, array_agg(measm.mmt_id) AS mmt FROM lada.sample JOIN lada.measm ON (sample.id = measm.sample_id) GROUP BY sample.id) mmtid ON sample.id = mmtid.pid'
    WHERE id = 14;
UPDATE master.base_query
    SET sql = 'SELECT measm.id, sample.id AS probeId, sample.main_sample_id AS hpNr, measm.min_sample_id AS npNr, status_prot.date AS statusD, regulation.name AS dBasis, meas_facil.network_id AS netzId, CASE WHEN sample.meas_facil_id = sample.appr_lab_id THEN sample.meas_facil_id ELSE sample.meas_facil_id || ''-'' || sample.appr_lab_id END AS mstLaborId, sample.env_medium_id AS umwId, sample_meth.ext_id AS pArt, sample.sample_start_date AS peBegin, sample.sample_end_date AS peEnd, site.admin_unit_id AS eGemId, admin_unit.name AS eGem, CASE WHEN h3.less_than_lod = ''<'' THEN h3.less_than_lod || translate(to_char(h3.detect_lim, ''0.99eeee''),''.'','','') ELSE translate(to_char(h3.meas_val, ''0.99eeee''),''.'','','') END AS h3, CASE WHEN k40.less_than_lod = ''<'' THEN k40.less_than_lod || translate(to_char(k40.detect_lim, ''0.99eeee''),''.'','','') ELSE translate(to_char(k40.meas_val, ''0.99eeee''),''.'','','') END AS k40, CASE WHEN co60.less_than_lod = ''<'' THEN co60.less_than_lod || translate(to_char(co60.detect_lim, ''0.99eeee''),''.'','','') ELSE translate(to_char(co60.meas_val, ''0.99eeee''),''.'','','') END AS co60, CASE WHEN sr89.less_than_lod = ''<'' THEN sr89.less_than_lod || translate(to_char(sr89.detect_lim, ''0.99eeee''),''.'','','') ELSE translate(to_char(sr89.meas_val, ''0.99eeee''),''.'','','') END AS sr89, CASE WHEN sr90.less_than_lod = ''<'' THEN sr90.less_than_lod || translate(to_char(sr90.detect_lim, ''0.99eeee''),''.'','','') ELSE translate(to_char(sr90.meas_val, ''0.99eeee''),''.'','','') END AS sr90, CASE WHEN ru103.less_than_lod = ''<'' THEN ru103.less_than_lod || translate(to_char(ru103.detect_lim, ''0.99eeee''),''.'','','') ELSE translate(to_char(ru103.meas_val, ''0.99eeee''),''.'','','') END AS ru103, CASE WHEN i131.less_than_lod = ''<'' THEN i131.less_than_lod || translate(to_char(i131.detect_lim, ''0.99eeee''),''.'','','') ELSE translate(to_char(i131.meas_val, ''0.99eeee''),''.'','','') END AS i131, CASE WHEN cs134.less_than_lod = ''<'' THEN cs134.less_than_lod || translate(to_char(cs134.detect_lim, ''0.99eeee''),''.'','','') ELSE translate(to_char(cs134.meas_val, ''0.99eeee''),''.'','','') END AS cs134, CASE WHEN cs137.less_than_lod = ''<'' THEN cs137.less_than_lod || translate(to_char(cs137.detect_lim, ''0.99eeee''),''.'','','') ELSE translate(to_char(cs137.meas_val, ''0.99eeee''),''.'','','') END AS cs137, CASE WHEN ce144.less_than_lod = ''<'' THEN ce144.less_than_lod || translate(to_char(ce144.detect_lim, ''0.99eeee''),''.'','','') ELSE translate(to_char(ce144.meas_val, ''0.99eeee''),''.'','','') END AS ce144, CASE WHEN u234.less_than_lod = ''<'' THEN u234.less_than_lod || translate(to_char(u234.detect_lim, ''0.99eeee''),''.'','','') ELSE translate(to_char(u234.meas_val, ''0.99eeee''),''.'','','') END AS u234, CASE WHEN u235.less_than_lod = ''<'' THEN u235.less_than_lod || translate(to_char(u235.detect_lim, ''0.99eeee''),''.'','','') ELSE translate(to_char(u235.meas_val, ''0.99eeee''),''.'','','') END AS u235, CASE WHEN u238.less_than_lod = ''<'' THEN u238.less_than_lod || translate(to_char(u238.detect_lim, ''0.99eeee''),''.'','','') ELSE translate(to_char(u238.meas_val, ''0.99eeee''),''.'','','') END AS u238, CASE WHEN pu238.less_than_lod = ''<'' THEN pu238.less_than_lod || translate(to_char(pu238.detect_lim, ''0.99eeee''),''.'','','') ELSE translate(to_char(pu238.meas_val, ''0.99eeee''),''.'','','') END AS pu238, CASE WHEN pu239.less_than_lod = ''<'' THEN pu239.less_than_lod || translate(to_char(pu239.detect_lim, ''0.99eeee''),''.'','','') ELSE translate(to_char(pu239.meas_val, ''0.99eeee''),''.'','','') END AS pu239, CASE WHEN pu23940.less_than_lod = ''<'' THEN pu23940.less_than_lod || translate(to_char(pu23940.detect_lim, ''0.99eeee''),''.'','','') ELSE translate(to_char(pu23940.meas_val, ''0.99eeee''),''.'','','') END AS pu23940, CASE WHEN te132.less_than_lod = ''<'' THEN te132.less_than_lod || translate(to_char(te132.detect_lim, ''0.99eeee''),''.'','','') ELSE translate(to_char(te132.meas_val, ''0.99eeee''),''.'','','') END AS te132, CASE WHEN pb212.less_than_lod = ''<'' THEN pb212.less_than_lod || translate(to_char(pb212.detect_lim, ''0.99eeee''),''.'','','') ELSE translate(to_char(pb212.meas_val, ''0.99eeee''),''.'','','') END AS pb212, CASE WHEN pb214.less_than_lod = ''<'' THEN pb214.less_than_lod || translate(to_char(pb214.detect_lim, ''0.99eeee''),''.'','','') ELSE translate(to_char(pb214.meas_val, ''0.99eeee''),''.'','','') END AS pb214, CASE WHEN bi212.less_than_lod = ''<'' THEN bi212.less_than_lod || translate(to_char(bi212.detect_lim, ''0.99eeee''),''.'','','') ELSE translate(to_char(bi212.meas_val, ''0.99eeee''),''.'','','') END AS bi212, CASE WHEN bi214.less_than_lod = ''<'' THEN bi214.less_than_lod || translate(to_char(bi214.detect_lim, ''0.99eeee''),''.'','','') ELSE translate(to_char(bi214.meas_val, ''0.99eeee''),''.'','','') END AS bi214, measm.mmt_id AS mmtId, sample.ext_id AS externeProbeId, measm.ext_id AS externeMessungsId, status_mp.id AS statusK, env_medium.name AS umw, network.name AS netzbetreiber, PUBLIC.ST_ASGEOJSON(site.geom) AS entnahmeGeom, sample.mpg_id AS mprId, mpg_categ.ext_id AS mplCode, mpg_categ.name AS mpl, sample.is_test, opr_mode.name AS messRegime, CASE WHEN sample.meas_facil_id = sample.appr_lab_id THEN meas_facil.name ELSE meas_facil.name || ''-'' || labormessstelle.name END AS mstLabor, measm.is_scheduled AS geplant, sample.sched_start_date AS sollBegin, sample.sched_end_date AS sollEnd, site.ext_id AS ortId, site.short_text AS ortKurztext, site.long_text AS ortLangtext, mmt.name AS mmt, measm.measm_start_date AS messbeginn, measm.meas_pd AS messdauer, sample.env_descrip_display AS deskriptoren, sample.env_descrip_name AS medium, geolocat.poi_id AS ozId, poi.name AS oz, admin_unit.rural_dist_id AS eKreisId, admin_unit.state_id AS eBlId, state.ctry AS eStaat, measm.is_completed AS fertig, staat_uo.ctry AS uStaat, ort_uo.ext_id AS uOrtId, sample.orig_date AS uZeit, array_to_string(tags.tags, '','', '''') AS tags, pkommentar.pkommentar AS pKommentar, mkommentar.mkommentar AS mKommentar, master.get_desk_description(sample.env_descrip_display, 0) AS desk0Beschr, master.get_desk_description(sample.env_descrip_display, 1) AS desk1Beschr, master.get_desk_description(sample.env_descrip_display, 2) AS desk2Beschr, master.get_desk_description(sample.env_descrip_display, 3) AS desk3Beschr, master.get_desk_description(sample.env_descrip_display, 4) AS desk4Beschr, ortszuordnung_uo.poi_id AS uOzId, ortszusatz_uo.name AS uOz, status_prot.text AS statusKommentar FROM lada.sample LEFT JOIN master.meas_facil ON (sample.meas_facil_id = meas_facil.id) LEFT JOIN master.meas_facil AS labormessstelle ON (sample.appr_lab_id = labormessstelle.id) INNER JOIN lada.measm ON sample.id = measm.sample_id INNER JOIN lada.status_prot ON measm.status = status_prot.id LEFT JOIN master.status_mp ON status_prot.status_mp_id = status_mp.id LEFT JOIN master.status_val ON status_val.id = status_mp.status_val_id LEFT JOIN master.status_lev ON status_lev.id = status_mp.status_lev_id LEFT JOIN master.regulation ON (sample.regulation_id = regulation.id) LEFT JOIN master.sample_meth ON (sample.sample_meth_id = sample_meth.id) LEFT JOIN lada.geolocat ON (sample.id = geolocat.sample_id AND geolocat.type_regulation IN (''E'', ''R'')) LEFT JOIN master.site ON (geolocat.site_id = site.id) LEFT JOIN master.admin_unit ON (site.admin_unit_id = admin_unit.id) LEFT JOIN master.poi ON (geolocat.poi_id = poi.id) LEFT JOIN master.state ON (site.state_id = state.id) LEFT JOIN lada.geolocat AS ortszuordnung_uo ON (sample.id = ortszuordnung_uo.sample_id AND ortszuordnung_uo.type_regulation IN (''U'', ''R'')) LEFT JOIN master.site AS ort_uo ON (ortszuordnung_uo.site_id = ort_uo.id)  LEFT JOIN master.state AS staat_uo ON (ort_uo.state_id = staat_uo.id)  LEFT JOIN master.poi AS ortszusatz_uo ON (ortszuordnung_uo.poi_id = ortszusatz_uo.id) LEFT JOIN master.env_medium ON (sample.env_medium_id = env_medium.id) LEFT JOIN master.network ON (meas_facil.network_id = network.id) LEFT JOIN master.mpg_categ ON (sample.mpg_categ_id = mpg_categ.id) LEFT JOIN master.opr_mode ON (sample.opr_mode_id = opr_mode.id) LEFT JOIN public.lada_meas_val h3 ON (h3.measm_id = measm.id AND h3.measd_id = 1) LEFT JOIN public.lada_meas_val k40 ON (k40.measm_id = measm.id AND k40.measd_id = 28) LEFT JOIN public.lada_meas_val co60 ON (co60.measm_id = measm.id AND co60.measd_id = 68) LEFT JOIN public.lada_meas_val sr89 ON (sr89.measm_id = measm.id AND sr89.measd_id = 164) LEFT JOIN public.lada_meas_val sr90 ON (sr90.measm_id = measm.id AND sr90.measd_id = 165) LEFT JOIN public.lada_meas_val ru103 ON (ru103.measm_id = measm.id AND ru103.measd_id = 220) LEFT JOIN public.lada_meas_val i131 ON (i131.measm_id = measm.id AND i131.measd_id = 340) LEFT JOIN public.lada_meas_val cs134 ON (cs134.measm_id = measm.id AND cs134.measd_id = 369) LEFT JOIN public.lada_meas_val cs137 ON (cs137.measm_id = measm.id AND cs137.measd_id = 373) LEFT JOIN public.lada_meas_val ce144 ON (ce144.measm_id = measm.id AND ce144.measd_id = 404) LEFT JOIN public.lada_meas_val u234 ON (u234.measm_id = measm.id AND u234.measd_id = 746) LEFT JOIN public.lada_meas_val u235 ON (u235.measm_id = measm.id AND u235.measd_id = 747) LEFT JOIN public.lada_meas_val u238 ON (u238.measm_id = measm.id AND u238.measd_id = 750) LEFT JOIN public.lada_meas_val pu238 ON (pu238.measm_id = measm.id AND pu238.measd_id = 768) LEFT JOIN public.lada_meas_val pu239 ON (pu239.measm_id = measm.id AND pu239.measd_id = 769) LEFT JOIN public.lada_meas_val pu23940 ON (pu23940.measm_id = measm.id AND pu23940.measd_id = 850) LEFT JOIN public.lada_meas_val te132 ON (te132.measm_id = measm.id AND te132.measd_id = 325) LEFT JOIN public.lada_meas_val pb212 ON (pb212.measm_id = measm.id AND pb212.measd_id = 672) LEFT JOIN public.lada_meas_val pb214 ON (pb214.measm_id = measm.id AND pb214.measd_id = 673) LEFT JOIN public.lada_meas_val bi212 ON (bi212.measm_id = measm.id AND bi212.measd_id = 684) LEFT JOIN public.lada_meas_val bi214 ON (bi214.measm_id = measm.id AND bi214.measd_id = 686) LEFT JOIN master.mmt ON (measm.mmt_id = mmt.id) LEFT JOIN  (   SELECT sample.id AS pid, measm.id AS mid, array_agg(tag.name) AS tags FROM lada.sample INNER JOIN lada.measm ON sample.id = measm.sample_id JOIN lada.tag_link_sample ON (sample.id = tag_link_sample.sample_id) JOIN lada.tag_link_measm ON (measm.id = tag_link_measm.measm_id) JOIN master.tag ON (tag_link_sample.tag_id = tag.id OR tag_link_measm.tag_id = tag.id)  GROUP BY sample.id, measm.id ) tags ON (sample.id = tags.pid AND measm.id = tags.mid) LEFT JOIN ( SELECT sample.id, string_agg(comm_sample.text,'' # '') AS pkommentar FROM lada.sample LEFT JOIN lada.comm_sample ON sample.id = comm_sample.sample_id GROUP BY sample.id) pkommentar  ON sample.id = pkommentar.id LEFT JOIN ( SELECT measm.id, string_agg(comm_measm.text, '' # '') AS mkommentar FROM lada.measm LEFT JOIN lada.comm_measm ON measm.id = comm_measm.measm_id GROUP BY measm.id) mkommentar  ON measm.id = mkommentar.id'
    WHERE id = 15;
UPDATE master.base_query
    SET sql = 'SELECT measm.id, sample.id AS probeId, sample.main_sample_id AS hpNr, measm.min_sample_id AS npNr, status_prot.date AS statusD, regulation.name AS dBasis, meas_facil.network_id AS netzId, CASE WHEN sample.meas_facil_id = sample.appr_lab_id THEN sample.meas_facil_id ELSE sample.meas_facil_id || ''-'' || sample.appr_lab_id END AS mstLaborId, sample.env_medium_id AS umwId, sample_meth.ext_id AS pArt, sample.sample_start_date AS peBegin, sample.sample_end_date AS peEnd, site.admin_unit_id AS eGemId, admin_unit.name AS eGem, CASE WHEN h3.less_than_lod = ''<'' THEN h3.less_than_lod || translate(to_char(h3.detect_lim, ''0.99eeee''),''.'','','') ELSE translate(to_char(h3.meas_val, ''0.99eeee''),''.'','','') END AS h3, CASE WHEN k40.less_than_lod = ''<'' THEN k40.less_than_lod || translate(to_char(k40.detect_lim, ''0.99eeee''),''.'','','') ELSE translate(to_char(k40.meas_val, ''0.99eeee''),''.'','','') END AS k40, CASE WHEN co60.less_than_lod = ''<'' THEN co60.less_than_lod || translate(to_char(co60.detect_lim, ''0.99eeee''),''.'','','') ELSE translate(to_char(co60.meas_val, ''0.99eeee''),''.'','','') END AS co60, CASE WHEN sr89.less_than_lod = ''<'' THEN sr89.less_than_lod || translate(to_char(sr89.detect_lim, ''0.99eeee''),''.'','','') ELSE translate(to_char(sr89.meas_val, ''0.99eeee''),''.'','','') END AS sr89, CASE WHEN sr90.less_than_lod = ''<'' THEN sr90.less_than_lod || translate(to_char(sr90.detect_lim, ''0.99eeee''),''.'','','') ELSE translate(to_char(sr90.meas_val, ''0.99eeee''),''.'','','') END AS sr90, CASE WHEN ru103.less_than_lod = ''<'' THEN ru103.less_than_lod || translate(to_char(ru103.detect_lim, ''0.99eeee''),''.'','','') ELSE translate(to_char(ru103.meas_val, ''0.99eeee''),''.'','','') END AS ru103, CASE WHEN i131.less_than_lod = ''<'' THEN i131.less_than_lod || translate(to_char(i131.detect_lim, ''0.99eeee''),''.'','','') ELSE translate(to_char(i131.meas_val, ''0.99eeee''),''.'','','') END AS i131, CASE WHEN cs134.less_than_lod = ''<'' THEN cs134.less_than_lod || translate(to_char(cs134.detect_lim, ''0.99eeee''),''.'','','') ELSE translate(to_char(cs134.meas_val, ''0.99eeee''),''.'','','') END AS cs134, CASE WHEN cs137.less_than_lod = ''<'' THEN cs137.less_than_lod || translate(to_char(cs137.detect_lim, ''0.99eeee''),''.'','','') ELSE translate(to_char(cs137.meas_val, ''0.99eeee''),''.'','','') END AS cs137, CASE WHEN ce144.less_than_lod = ''<'' THEN ce144.less_than_lod || translate(to_char(ce144.detect_lim, ''0.99eeee''),''.'','','') ELSE translate(to_char(ce144.meas_val, ''0.99eeee''),''.'','','') END AS ce144, CASE WHEN u234.less_than_lod = ''<'' THEN u234.less_than_lod || translate(to_char(u234.detect_lim, ''0.99eeee''),''.'','','') ELSE translate(to_char(u234.meas_val, ''0.99eeee''),''.'','','') END AS u234, CASE WHEN u235.less_than_lod = ''<'' THEN u235.less_than_lod || translate(to_char(u235.detect_lim, ''0.99eeee''),''.'','','') ELSE translate(to_char(u235.meas_val, ''0.99eeee''),''.'','','') END AS u235, CASE WHEN u238.less_than_lod = ''<'' THEN u238.less_than_lod || translate(to_char(u238.detect_lim, ''0.99eeee''),''.'','','') ELSE translate(to_char(u238.meas_val, ''0.99eeee''),''.'','','') END AS u238, CASE WHEN pu238.less_than_lod = ''<'' THEN pu238.less_than_lod || translate(to_char(pu238.detect_lim, ''0.99eeee''),''.'','','') ELSE translate(to_char(pu238.meas_val, ''0.99eeee''),''.'','','') END AS pu238, CASE WHEN pu239.less_than_lod = ''<'' THEN pu239.less_than_lod || translate(to_char(pu239.detect_lim, ''0.99eeee''),''.'','','') ELSE translate(to_char(pu239.meas_val, ''0.99eeee''),''.'','','') END AS pu239, CASE WHEN pu23940.less_than_lod = ''<'' THEN pu23940.less_than_lod || translate(to_char(pu23940.detect_lim, ''0.99eeee''),''.'','','') ELSE translate(to_char(pu23940.meas_val, ''0.99eeee''),''.'','','') END AS pu23940, CASE WHEN te132.less_than_lod = ''<'' THEN te132.less_than_lod || translate(to_char(te132.detect_lim, ''0.99eeee''),''.'','','') ELSE translate(to_char(te132.meas_val, ''0.99eeee''),''.'','','') END AS te132, CASE WHEN pb212.less_than_lod = ''<'' THEN pb212.less_than_lod || translate(to_char(pb212.detect_lim, ''0.99eeee''),''.'','','') ELSE translate(to_char(pb212.meas_val, ''0.99eeee''),''.'','','') END AS pb212, CASE WHEN pb214.less_than_lod = ''<'' THEN pb214.less_than_lod || translate(to_char(pb214.detect_lim, ''0.99eeee''),''.'','','') ELSE translate(to_char(pb214.meas_val, ''0.99eeee''),''.'','','') END AS pb214, CASE WHEN bi212.less_than_lod = ''<'' THEN bi212.less_than_lod || translate(to_char(bi212.detect_lim, ''0.99eeee''),''.'','','') ELSE translate(to_char(bi212.meas_val, ''0.99eeee''),''.'','','') END AS bi212, CASE WHEN bi214.less_than_lod = ''<'' THEN bi214.less_than_lod || translate(to_char(bi214.detect_lim, ''0.99eeee''),''.'','','') ELSE translate(to_char(bi214.meas_val, ''0.99eeee''),''.'','','') END AS bi214, measm.mmt_id AS mmtId, sample.ext_id AS externeProbeId, measm.ext_id AS externeMessungsId, status_mp.id AS statusK, env_medium.name AS umw, network.name AS netzbetreiber, PUBLIC.ST_ASGEOJSON(site.geom) AS entnahmeGeom, nucl_facil_gr.ext_id AS anlage, nucl_facil_gr.name AS anlagebeschr, rei_ag_gr.name AS reiproggrp, rei_ag_gr.descr AS reiproggrpbeschr, sample.mpg_id AS mprId, mpg_categ.ext_id AS mplCode, mpg_categ.name AS mpl, sample.is_test, opr_mode.name AS messRegime, CASE WHEN sample.meas_facil_id = sample.appr_lab_id THEN meas_facil.name ELSE meas_facil.name || ''-'' || labormessstelle.name END AS mstLabor, measm.is_scheduled AS geplant, sample.sched_start_date AS sollBegin, sample.sched_end_date AS sollEnd, site.ext_id AS ortId, site.short_text AS ortKurztext, site.long_text AS ortLangtext, sampler.descr AS prnBezeichnung, sampler.ext_id AS prnId, sampler.short_text AS prnKurzBezeichnung, mmt.name AS mmt, measm.measm_start_date AS messbeginn, measm.meas_pd AS messdauer, sample.env_descrip_display AS deskriptoren, sample.env_descrip_name AS medium, geolocat.poi_id AS ozId, poi.name AS oz, admin_unit.rural_dist_id AS eKreisId, admin_unit.state_id AS eBlId, state.ctry AS eStaat, measm.is_completed AS fertig, (query_measm_view.measm_id IS NOT NULL) AS hatRueckfrage, staat_uo.ctry AS uStaat, ort_uo.ext_id AS uOrtId, sample.orig_date AS uZeit, array_to_string(tags.tags, '','', '''') AS tags, pzs.pzs, ortszuordnung_uo.poi_id AS uOzId, ortszusatz_uo.name AS uOz, status_prot.text AS statusKommentar FROM lada.sample LEFT JOIN master.meas_facil ON (sample.meas_facil_id = meas_facil.id) LEFT JOIN master.meas_facil AS labormessstelle ON (sample.appr_lab_id = labormessstelle.id) INNER JOIN lada.measm ON sample.id = measm.sample_id INNER JOIN lada.status_prot ON measm.status = status_prot.id LEFT JOIN master.status_mp ON status_prot.status_mp_id = status_mp.id LEFT JOIN master.status_val ON status_val.id = status_mp.status_val_id LEFT JOIN master.status_lev ON status_lev.id = status_mp.status_lev_id LEFT JOIN lada.query_measm_view ON query_measm_view.measm_id = measm.id LEFT JOIN master.regulation ON (sample.regulation_id = regulation.id) LEFT JOIN master.sample_meth ON (sample.sample_meth_id = sample_meth.id) LEFT JOIN lada.geolocat ON (sample.id = geolocat.sample_id AND geolocat.type_regulation IN (''E'', ''R'')) LEFT JOIN master.site ON (geolocat.site_id = site.id) LEFT JOIN master.admin_unit ON (site.admin_unit_id = admin_unit.id) LEFT JOIN master.poi ON (geolocat.poi_id = poi.id) LEFT JOIN master.state ON (site.state_id = state.id) LEFT JOIN lada.geolocat AS ortszuordnung_uo ON (sample.id = ortszuordnung_uo.sample_id AND ortszuordnung_uo.type_regulation IN (''U'', ''R'')) LEFT JOIN master.site AS ort_uo ON (ortszuordnung_uo.site_id = ort_uo.id)  LEFT JOIN master.state AS staat_uo ON (ort_uo.state_id = staat_uo.id)  LEFT JOIN master.poi AS ortszusatz_uo ON (ortszuordnung_uo.poi_id = ortszusatz_uo.id) LEFT JOIN master.env_medium ON (sample.env_medium_id = env_medium.id) LEFT JOIN master.network ON (meas_facil.network_id = network.id) LEFT JOIN master.nucl_facil_gr ON (sample.nucl_facil_gr_id = nucl_facil_gr.id) LEFT JOIN master.rei_ag_gr ON (sample.rei_ag_gr_id = rei_ag_gr.id) LEFT JOIN master.mpg_categ ON (sample.mpg_categ_id = mpg_categ.id) LEFT JOIN master.opr_mode ON (sample.opr_mode_id = opr_mode.id) LEFT JOIN public.lada_meas_val h3 ON (h3.measm_id = measm.id AND h3.measd_id = 1) LEFT JOIN public.lada_meas_val k40 ON (k40.measm_id = measm.id AND k40.measd_id = 28) LEFT JOIN public.lada_meas_val co60 ON (co60.measm_id = measm.id AND co60.measd_id = 68) LEFT JOIN public.lada_meas_val sr89 ON (sr89.measm_id = measm.id AND sr89.measd_id = 164) LEFT JOIN public.lada_meas_val sr90 ON (sr90.measm_id = measm.id AND sr90.measd_id = 165) LEFT JOIN public.lada_meas_val ru103 ON (ru103.measm_id = measm.id AND ru103.measd_id = 220) LEFT JOIN public.lada_meas_val i131 ON (i131.measm_id = measm.id AND i131.measd_id = 340) LEFT JOIN public.lada_meas_val cs134 ON (cs134.measm_id = measm.id AND cs134.measd_id = 369) LEFT JOIN public.lada_meas_val cs137 ON (cs137.measm_id = measm.id AND cs137.measd_id = 373) LEFT JOIN public.lada_meas_val ce144 ON (ce144.measm_id = measm.id AND ce144.measd_id = 404) LEFT JOIN public.lada_meas_val u234 ON (u234.measm_id = measm.id AND u234.measd_id = 746) LEFT JOIN public.lada_meas_val u235 ON (u235.measm_id = measm.id AND u235.measd_id = 747) LEFT JOIN public.lada_meas_val u238 ON (u238.measm_id = measm.id AND u238.measd_id = 750) LEFT JOIN public.lada_meas_val pu238 ON (pu238.measm_id = measm.id AND pu238.measd_id = 768) LEFT JOIN public.lada_meas_val pu239 ON (pu239.measm_id = measm.id AND pu239.measd_id = 769) LEFT JOIN public.lada_meas_val pu23940 ON (pu23940.measm_id = measm.id AND pu23940.measd_id = 850) LEFT JOIN public.lada_meas_val te132 ON (te132.measm_id = measm.id AND te132.measd_id = 325) LEFT JOIN public.lada_meas_val pb212 ON (pb212.measm_id = measm.id AND pb212.measd_id = 672) LEFT JOIN public.lada_meas_val pb214 ON (pb214.measm_id = measm.id AND pb214.measd_id = 673) LEFT JOIN public.lada_meas_val bi212 ON (bi212.measm_id = measm.id AND bi212.measd_id = 684) LEFT JOIN public.lada_meas_val bi214 ON (bi214.measm_id = measm.id AND bi214.measd_id = 686) LEFT JOIN master.sampler ON (sample.sampler_id = sampler.id) LEFT JOIN master.mmt ON (measm.mmt_id = mmt.id) LEFT JOIN  (   SELECT sample.id AS pid, measm.id AS mid, array_agg(tag.name) AS tags FROM lada.sample INNER JOIN lada.measm ON sample.id = measm.sample_id JOIN lada.tag_link_sample ON (sample.id = tag_link_sample.sample_id) JOIN lada.tag_link_measm ON (measm.id = tag_link_measm.measm_id) JOIN master.tag ON (tag_link_sample.tag_id = tag.id OR tag_link_measm.tag_id = tag.id)  GROUP BY sample.id, measm.id ) tags ON (sample.id = tags.pid AND measm.id = tags.mid) LEFT JOIN ( SELECT sample.id, array_to_string(array_agg(sample_specif_meas_val.sample_specif_id || '' '' || sample_specif.name || '': '' ||  coalesce(sample_specif_meas_val.smaller_than,'''') || '' '' || coalesce(translate(to_char(sample_specif_meas_val.meas_val,''9.99EEEE''),''.'','',''),'''') || '' '' || coalesce(pzsmeh.unit_symbol,'''') || CASE WHEN sample_specif_meas_val.error IS NOT NULL THEN '' +/-'' ELSE '''' END || coalesce(translate(to_char(sample_specif_meas_val.error,''99.9''),''.'','',''),'''') || CASE WHEN sample_specif_meas_val.error IS NOT NULL THEN '' %'' ELSE '''' END), '' # '', '''') AS pzs FROM lada.sample LEFT JOIN lada.sample_specif_meas_val ON (sample.id =  sample_specif_meas_val.sample_id) LEFT JOIN master.sample_specif ON (sample_specif_meas_val.sample_specif_id = sample_specif.id) LEFT JOIN master.meas_unit AS pzsmeh ON (sample_specif.meas_unit_id = pzsmeh.id) GROUP BY sample.id) pzs ON sample.id = pzs.id'
    WHERE id = 16;
UPDATE master.base_query
    SET sql = 'SELECT measm.id, sample.id AS probeId, sample.main_sample_id AS hpNr, measm.min_sample_id AS npNr, status_prot.date AS statusD, regulation.name AS dBasis, meas_facil.network_id AS netzId, CASE WHEN sample.meas_facil_id = sample.appr_lab_id THEN sample.meas_facil_id ELSE sample.meas_facil_id || ''-'' || sample.appr_lab_id END AS mstLaborId, sample.env_medium_id AS umwId, sample_meth.ext_id AS pArt, sample.sample_start_date AS peBegin, sample.sample_end_date AS peEnd, site.admin_unit_id AS eGemId, admin_unit.name AS eGem, measd.name AS messgroesse, coalesce(public.lada_meas_val.less_than_lod, '' '') AS nwg, public.lada_meas_val.meas_val AS wert, public.lada_meas_val.detect_lim AS nwgZuMesswert, public.lada_meas_val.error AS fehler, meas_unit.unit_symbol AS einheit, measm.mmt_id AS mmtId, sample.ext_id AS externeProbeId, measm.ext_id AS externeMessungsId, status_mp.id AS statusK, env_medium.name AS umw, network.name AS netzbetreiber, PUBLIC.ST_ASGEOJSON(site.geom) AS entnahmeGeom, nucl_facil_gr.ext_id AS anlage, nucl_facil_gr.name AS anlagebeschr, rei_ag_gr.name AS reiproggrp, rei_ag_gr.descr AS reiproggrpbeschr, sample.mpg_id AS mprId, mpg_categ.ext_id AS mplCode, mpg_categ.name AS mpl, sample.is_test, opr_mode.name AS messRegime, CASE WHEN sample.meas_facil_id = sample.appr_lab_id THEN meas_facil.name ELSE meas_facil.name || ''-'' || labormessstelle.name END AS mstLabor, measm.is_scheduled AS geplant, sample.sched_start_date AS sollBegin, sample.sched_end_date AS sollEnd, sampler.descr AS prnBezeichnung, sampler.ext_id AS prnId, sampler.short_text AS prnKurzBezeichnung, mmt.name AS mmt, measm.measm_start_date AS messbeginn, measm.meas_pd AS messdauer, site.short_text AS ortKurztext, site.long_text AS ortLangtext, sample.env_descrip_display AS deskriptoren, sample.env_descrip_name AS medium, geolocat.poi_id AS ozId, poi.name AS oz, admin_unit.rural_dist_id AS eKreisId, admin_unit.state_id AS eBlId, state.ctry AS eStaat, coalesce(public.lada_meas_val.meas_val,public.lada_meas_val.detect_lim) AS wertNwg, site.ext_id AS ortId, staat_uo.ctry AS uStaat, ort_uo.ext_id AS uOrtId, sample.orig_date AS uZeit, array_to_string(tags.tags, '','', '''') AS tags, public.lada_meas_val.id AS messwertId, ortszuordnung_uo.poi_id AS uOzId, ortszusatz_uo.name AS uOz FROM lada.sample LEFT JOIN master.meas_facil ON (sample.meas_facil_id = meas_facil.id) LEFT JOIN master.meas_facil AS labormessstelle ON (sample.appr_lab_id = labormessstelle.id) JOIN lada.measm ON sample.id = measm.sample_id JOIN lada.status_prot ON measm.status = status_prot.id JOIN master.status_mp ON status_prot.status_mp_id = status_mp.id JOIN master.status_val ON status_val.id = status_mp.status_val_id JOIN master.status_lev ON status_lev.id = status_mp.status_lev_id LEFT JOIN master.regulation ON (sample.regulation_id = regulation.id) LEFT JOIN master.sample_meth ON (sample.sample_meth_id = sample_meth.id) LEFT JOIN lada.geolocat ON (sample.id = geolocat.sample_id AND geolocat.type_regulation IN (''E'', ''R'')) LEFT JOIN master.site ON (geolocat.site_id = site.id) LEFT JOIN master.admin_unit ON (site.admin_unit_id = admin_unit.id) LEFT JOIN master.poi ON (geolocat.poi_id = poi.id) LEFT JOIN master.state ON (site.state_id = state.id) LEFT JOIN lada.geolocat AS ortszuordnung_uo ON (sample.id = ortszuordnung_uo.sample_id AND ortszuordnung_uo.type_regulation IN (''U'', ''R'')) LEFT JOIN master.site AS ort_uo ON (ortszuordnung_uo.site_id = ort_uo.id)  LEFT JOIN master.state AS staat_uo ON (ort_uo.state_id = staat_uo.id)  LEFT JOIN master.poi AS ortszusatz_uo ON (ortszuordnung_uo.poi_id = ortszusatz_uo.id) LEFT JOIN master.env_medium ON (sample.env_medium_id = env_medium.id) LEFT JOIN master.network ON (meas_facil.network_id = network.id) LEFT JOIN master.nucl_facil_gr ON (sample.nucl_facil_gr_id = nucl_facil_gr.id) LEFT JOIN master.rei_ag_gr ON (sample.rei_ag_gr_id = rei_ag_gr.id) LEFT JOIN master.mpg_categ ON (sample.mpg_categ_id = mpg_categ.id) LEFT JOIN master.opr_mode ON (sample.opr_mode_id = opr_mode.id) JOIN public.lada_meas_val ON (public.lada_meas_val.measm_id = measm.id) JOIN master.measd ON (measd.id = public.lada_meas_val.measd_id) LEFT JOIN master.meas_unit ON (meas_unit.id = public.lada_meas_val.meas_unit_id) LEFT JOIN master.sampler ON (sample.sampler_id = sampler.id) LEFT JOIN master.mmt ON (measm.mmt_id = mmt.id) LEFT JOIN  ( SELECT sample.id AS pid, measm.id AS mid, array_agg(tag.name) AS tags FROM lada.sample INNER JOIN lada.measm ON sample.id = measm.sample_id JOIN lada.tag_link_sample ON (sample.id = tag_link_sample.sample_id) JOIN lada.tag_link_measm ON (measm.id = tag_link_measm.measm_id) JOIN master.tag ON (tag_link_sample.tag_id = tag.id OR tag_link_measm.tag_id = tag.id)  GROUP BY sample.id, measm.id ) tags ON (sample.id = tags.pid AND measm.id = tags.mid)'
    WHERE id = 41;
UPDATE master.base_query
    SET sql = 'SELECT measm.id, sample.id AS probeId, sample.main_sample_id AS hpNr, measm.min_sample_id AS npNr, status_prot.date AS statusD, regulation.name AS dBasis, meas_facil.network_id AS netzId, CASE      WHEN sample.meas_facil_id = sample.appr_lab_id       THEN sample.meas_facil_id     ELSE sample.meas_facil_id || ''-'' || sample.appr_lab_id     END AS mstLaborId,  sample.env_medium_id AS umwId,  site.ext_id AS ortId, sample.sample_start_date AS peBegin,   sample.sample_end_date AS peEnd,   site.admin_unit_id AS eGemId, admin_unit.name AS eGem, measd.name AS messgroesse, coalesce(public.lada_meas_val.less_than_lod, '' '') AS nwg, public.lada_meas_val.meas_val AS wert, public.lada_meas_val.detect_lim AS nwgZuMesswert, public.lada_meas_val.error AS fehler, meas_unit.unit_symbol AS einheit, measm.mmt_id AS mmtId, sample.ext_id AS externeProbeId, measm.ext_id AS externeMessungsId, status_mp.id AS statusK, env_medium.name AS umw,   network.name AS netzbetreiber,   nucl_facil_gr.ext_id AS anlage,   nucl_facil_gr.name AS anlagebeschr,   rei_ag_gr.name AS reiproggrp,   rei_ag_gr.descr AS reiproggrpbeschr,  site.rei_report_text AS berichtstext, sample.is_test,  opr_mode.name AS messRegime,  CASE      WHEN sample.meas_facil_id = sample.appr_lab_id       THEN meas_facil.name     ELSE meas_facil.name || ''-'' || labormessstelle.name     END AS mstLabor,  measm.is_scheduled AS geplant, sample.sched_start_date AS sollBegin,   sample.sched_end_date AS sollEnd, mmt.name AS mmt, measm.measm_start_date AS messbeginn, measm.meas_pd AS messdauer, site.short_text AS ortKurztext,   site.long_text AS ortLangtext,  sample.env_descrip_name AS medium, sample.mid_coll_pd AS mitteSammelzeitraum, extract(quarter FROM sample.mid_coll_pd) AS qmitteSammelzeitraum, extract(year FROM sample.mid_coll_pd) AS jmitteSammelzeitraum, pzs.pzs, pkommentar.pkommentar AS pKommentar, mkommentar.mkommentar AS mKommentar, array_to_string(tags.tags, '','', '''') AS tags, meas_facil.address AS messstellenadr, measd.id AS mgrId, labormessstelle.address AS messlaboradr, sample.appr_lab_id AS laborMstId, sample.meas_facil_id AS mstId, public.lada_meas_val.id AS messwertId FROM lada.sample LEFT JOIN  (   SELECT sample.id,     array_agg(tag.name) AS tags   FROM lada.sample   JOIN lada.tag_link_sample ON sample.id = tag_link_sample.sample_id   JOIN master.tag ON tag_link_sample.tag_id = tag.id   GROUP BY sample.id  ) tags ON sample.id = tags.id LEFT JOIN master.meas_facil ON (sample.meas_facil_id = meas_facil.id) LEFT JOIN master.meas_facil AS labormessstelle ON (sample.appr_lab_id = labormessstelle.id) JOIN lada.measm ON sample.id = measm.sample_id JOIN lada.status_prot ON measm.status = status_prot.id JOIN master.status_mp ON status_prot.status_mp_id = status_mp.id JOIN master.status_val ON status_val.id = status_mp.status_val_id JOIN master.status_lev ON status_lev.id = status_mp.status_lev_id LEFT JOIN master.regulation ON (sample.regulation_id = regulation.id) LEFT JOIN lada.geolocat ON (sample.id = geolocat.sample_id AND geolocat.type_regulation IN (''E'', ''R'')) LEFT JOIN master.site ON (geolocat.site_id = site.id) LEFT JOIN master.admin_unit ON (site.admin_unit_id = admin_unit.id) LEFT JOIN master.env_medium ON (sample.env_medium_id = env_medium.id) LEFT JOIN master.network ON (meas_facil.network_id = network.id) LEFT JOIN master.nucl_facil_gr ON (sample.nucl_facil_gr_id = nucl_facil_gr.id) LEFT JOIN master.rei_ag_gr ON (sample.rei_ag_gr_id = rei_ag_gr.id) LEFT JOIN master.opr_mode ON (sample.opr_mode_id = opr_mode.id) LEFT JOIN public.lada_meas_val ON (public.lada_meas_val.measm_id = measm.id) LEFT JOIN master.measd ON (measd.id = public.lada_meas_val.measd_id) LEFT JOIN master.meas_unit ON (meas_unit.id = public.lada_meas_val.meas_unit_id) LEFT JOIN master.mmt ON (measm.mmt_id = mmt.id) LEFT JOIN ( SELECT sample.id, array_to_string(array_agg(sample_specif.name || '': '' || coalesce(sample_specif_meas_val.smaller_than,'''') || '' '' || (case when sample_specif_meas_val.meas_val = 0 then to_char(sample_specif_meas_val.meas_val,''9'') else translate(to_char(sample_specif_meas_val.meas_val,''9990.9''),''. '','','') end) || '' '' || pzsmeh.unit_symbol), '' # '', '''') AS pzs FROM lada.sample LEFT JOIN lada.sample_specif_meas_val ON ( sample.id = sample_specif_meas_val.sample_id AND sample_specif_meas_val.sample_specif_id = ''A25'') LEFT JOIN master.sample_specif ON (sample_specif_meas_val.sample_specif_id = master.sample_specif.id) LEFT JOIN master.meas_unit AS pzsmeh ON (sample_specif.meas_unit_id = pzsmeh.id) GROUP BY sample.id) pzs ON sample.id = pzs.id LEFT JOIN ( SELECT sample.id, string_agg(comm_sample.text, '' # '') AS pkommentar FROM lada.sample LEFT JOIN lada.comm_sample ON sample.id = comm_sample.sample_id WHERE NOT comm_sample.text LIKE ''(X)%'' GROUP BY sample.id) pkommentar ON sample.id = pkommentar.id LEFT JOIN ( SELECT measm.id, string_agg(comm_measm.text, '' # '') AS mkommentar FROM lada.measm LEFT JOIN lada.comm_measm ON measm.id = comm_measm.measm_id WHERE NOT comm_measm.text LIKE ''(X)%'' GROUP BY measm.id) mkommentar ON measm.id = mkommentar.id'
    WHERE id = 42;
UPDATE master.base_query
    SET sql = 'SELECT measm.id, sample.id AS probeId, sample.main_sample_id AS hpNr, measm.min_sample_id AS npNr, status_prot.date AS statusD, regulation.name AS dBasis, meas_facil.network_id AS netzId, CASE      WHEN sample.meas_facil_id = sample.appr_lab_id       THEN sample.meas_facil_id     ELSE sample.meas_facil_id || ''-'' || sample.appr_lab_id     END AS mstLaborId,  sample.env_medium_id AS umwId,   sample_meth.ext_id AS pArt,  sample.sample_start_date AS peBegin,   sample.sample_end_date AS peEnd,   site.admin_unit_id AS eGemId, admin_unit.name AS eGem, measd.name AS messgroesse, CASE WHEN (convers_dm_fm.conv_factor IS NOT NULL) OR (lada_meas_val.meas_unit_id = env_medium.unit_1)  THEN coalesce(lada_meas_val.less_than_lod, '' '') ELSE NULL END AS nwg, CASE WHEN convers_dm_fm.conv_factor IS NOT NULL THEN convers_dm_fm.conv_factor*lada_meas_val.meas_val WHEN lada_meas_val.meas_unit_id = env_medium.unit_1 THEN lada_meas_val.meas_val ELSE NULL END AS wert, CASE WHEN convers_dm_fm.conv_factor IS NOT NULL THEN convers_dm_fm.conv_factor*lada_meas_val.detect_lim WHEN lada_meas_val.meas_unit_id = env_medium.unit_1 THEN lada_meas_val.detect_lim ELSE NULL END AS nwgZuMesswert, CASE  WHEN (convers_dm_fm.conv_factor IS NOT NULL) OR (lada_meas_val.meas_unit_id = env_medium.unit_1)  THEN lada_meas_val.error  ELSE NULL END AS fehler, CASE  WHEN convers_dm_fm.conv_factor IS NOT NULL THEN mess_einheit_tm.unit_symbol WHEN lada_meas_val.meas_unit_id = env_medium.unit_1 THEN meas_unit.unit_symbol  ELSE NULL END AS einheit,  measm.mmt_id AS mmtId, sample.ext_id AS externeProbeId, measm.ext_id AS externeMessungsId, status_mp.id AS statusK, env_medium.name AS umw,   network.name AS netzbetreiber,   PUBLIC.ST_ASGEOJSON(site.geom) AS entnahmeGeom, nucl_facil_gr.ext_id AS anlage,   nucl_facil_gr.name AS anlagebeschr,   rei_ag_gr.name AS reiproggrp,   rei_ag_gr.descr AS reiproggrpbeschr,  sample.mpg_id AS mprId,   mpg_categ.ext_id AS mplCode,   mpg_categ.name AS mpl,   sample.is_test,   opr_mode.name AS messRegime,  CASE      WHEN sample.meas_facil_id = sample.appr_lab_id       THEN meas_facil.name     ELSE meas_facil.name || ''-'' || labormessstelle.name     END AS mstLabor,  measm.is_scheduled AS geplant, sample.sched_start_date AS sollBegin,   sample.sched_end_date AS sollEnd,   sampler.descr AS prnBezeichnung,   sampler.ext_id AS prnId,   sampler.short_text AS prnKurzBezeichnung,   mmt.name AS mmt, measm.measm_start_date AS messbeginn, measm.meas_pd AS messdauer, site.short_text AS ortKurztext,   site.long_text AS ortLangtext,  sample.env_descrip_display AS deskriptoren,   sample.env_descrip_name AS medium, geolocat.poi_id AS ozId,   poi.name AS oz,   admin_unit.rural_dist_id AS eKreisId,   admin_unit.state_id AS eBlId,   state.ctry AS eStaat,  CASE  WHEN convers_dm_fm.conv_factor IS NOT NULL THEN convers_dm_fm.conv_factor*coalesce(lada_meas_val.meas_val,lada_meas_val.detect_lim) WHEN lada_meas_val.meas_unit_id = env_medium.unit_1 THEN coalesce(lada_meas_val.meas_val,lada_meas_val.detect_lim) ELSE NULL END AS wertNwg, site.ext_id AS ortId,   staat_uo.ctry AS uStaat, ort_uo.ext_id AS uOrtId, sample.orig_date AS uZeit, array_to_string(tags.tags, '','', '''') AS tags, CASE  WHEN lada_meas_val.meas_unit_id = env_medium.unit_2 THEN CASE WHEN lada_meas_val.less_than_lod = ''<'' THEN lada_meas_val.less_than_lod || translate(to_char( lada_meas_val.detect_lim, ''0.99eeee''),''.'','','') || '' '' || meas_unit.unit_symbol ELSE translate(to_char(lada_meas_val.meas_val, ''0.99eeee''),''.'','','') || '' '' || meas_unit.unit_symbol  END ELSE '' '' END AS kombiSekMeh, CASE WHEN lada_meas_val.meas_unit_id = env_medium.unit_2 THEN true ELSE false END AS booleanSekMeh, convers_dm_fm.conv_factor AS faktorSekMeh, lada_meas_val.id AS messwertId, ortszuordnung_uo.poi_id AS uOzId,  ortszusatz_uo.name AS uOz FROM lada.sample LEFT JOIN master.meas_facil ON (sample.meas_facil_id = meas_facil.id) LEFT JOIN master.meas_facil AS labormessstelle ON (sample.appr_lab_id = labormessstelle.id) JOIN lada.measm ON sample.id = measm.sample_id JOIN lada.status_prot ON measm.status = status_prot.id JOIN master.status_mp ON status_prot.status_mp_id = status_mp.id JOIN master.status_val ON status_val.id = status_mp.status_val_id JOIN master.status_lev ON status_lev.id = status_mp.status_lev_id LEFT JOIN master.regulation ON (sample.regulation_id = regulation.id) LEFT JOIN master.sample_meth ON (sample.sample_meth_id = sample_meth.id) LEFT JOIN lada.geolocat ON (sample.id = geolocat.sample_id AND geolocat.type_regulation IN (''E'', ''R'')) LEFT JOIN master.site ON (geolocat.site_id = site.id) LEFT JOIN master.admin_unit ON (site.admin_unit_id = admin_unit.id) LEFT JOIN master.poi ON (geolocat.poi_id = poi.id) LEFT JOIN master.state ON (site.state_id = state.id) LEFT JOIN lada.geolocat AS ortszuordnung_uo ON (sample.id = ortszuordnung_uo.sample_id AND ortszuordnung_uo.type_regulation IN (''U'', ''R'')) LEFT JOIN master.site AS ort_uo ON (ortszuordnung_uo.site_id = ort_uo.id)  LEFT JOIN master.state AS staat_uo ON (ort_uo.state_id = staat_uo.id)  LEFT JOIN master.poi AS ortszusatz_uo ON (ortszuordnung_uo.poi_id = ortszusatz_uo.id) LEFT JOIN master.env_medium ON (sample.env_medium_id = env_medium.id) LEFT JOIN master.network ON (meas_facil.network_id = network.id) LEFT JOIN master.nucl_facil_gr ON (sample.nucl_facil_gr_id = nucl_facil_gr.id) LEFT JOIN master.rei_ag_gr ON (sample.rei_ag_gr_id = rei_ag_gr.id) LEFT JOIN master.mpg_categ ON (sample.mpg_categ_id = mpg_categ.id) LEFT JOIN master.opr_mode ON (sample.opr_mode_id = opr_mode.id) JOIN public.lada_meas_val ON (public.lada_meas_val.measm_id = measm.id) JOIN master.measd ON (measd.id = public.lada_meas_val.measd_id) LEFT JOIN master.meas_unit ON (meas_unit.id = public.lada_meas_val.meas_unit_id) LEFT JOIN master.sampler ON (sample.sampler_id = sampler.id) LEFT JOIN master.mmt ON (measm.mmt_id = mmt.id) LEFT JOIN  (   SELECT sample.id AS pid, measm.id AS mid, array_agg(tag.name) AS tags   FROM lada.sample   INNER JOIN lada.measm ON sample.id = measm.sample_id JOIN lada.tag_link_sample ON (sample.id = tag_link_sample.sample_id) JOIN lada.tag_link_measm ON (measm.id = tag_link_measm.measm_id) JOIN master.tag ON (tag_link_sample.tag_id = tag.id OR tag_link_measm.tag_id = tag.id)   GROUP BY sample.id, measm.id ) tags ON (sample.id = tags.pid AND measm.id = tags.mid) LEFT JOIN master.convers_dm_fm ON (lada_meas_val.meas_unit_id = convers_dm_fm.meas_unit_id AND sample.env_medium_id = convers_dm_fm.env_medium_id AND sample.env_descrip_display LIKE convers_dm_fm.env_descrip_pattern) LEFT JOIN master.meas_unit AS mess_einheit_tm ON (convers_dm_fm.to_meas_unit_id = mess_einheit_tm.id)'
    WHERE id = 43;


DROP table tag_link;